---
title: "Starwars Flex Dashboard"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: row
    vertical_layout: fill
    theme: sandstone
    favicon: favicon.ico
---

```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(reshape2)
library(dplyr)
library(plotly)

pdf(NULL)

cost_rev_load <- read.csv('cost_rev.csv', header = TRUE)
cost_rev <- as_tibble(cost_rev_load)
cost_rev <- select(cost_rev_load, -ends_with("number"))

cost_rev <- cost_rev_load %>%
  filter(grepl("2018", general_ledger_date) )  %>%
    filter(grepl("GRANTS", object_account_description)|
            grepl("CDBG-CITY PLANNING",object_account_description)|
              grepl("BOND PROCEEDS",object_account_description)) %>%
  mutate(amount = as.numeric(amount),
         department_name = as.character(department_name),
         date_2018 = as.character(general_ledger_date),
         cost_center_description = as.character(cost_center_description),
         X_id = as.factor(X_id))


crInput <- reactive({
  cost_rev <- cost_rev %>% 
  #Slider filter
    filter(date_2018 >= input$DateSelect[1] & date <= input$DateSelect[2])
  #Department Filter
  if (length(input$DepartmentSelect) > 0) {
    cost_rev <- subset(cost_rev, department_name %in% input$DepartmentSelect)
  }
  #Account Filter
  if (length(input$AccountSelct) > 0 ) {
    cost_rev <- subset(cost_rev, object_account_description %in% input$AccountSelct)
  }
  #Amount Filter
  if (length(input$AmountSelct) > 0 ) {
    cost_rev <- subset(cost_rev, amount %in% input$AmountSelct)
  }
  #Date Filter
  if (length(input$DateSelct) > 0 ) {
    cost_rev <- subset(cost_rev, date_2018 %in% input$DateSelct)
  }
  return(cost_rev)
})

#Reactive melted data
crInput <- reactive({
  crInput() %>%
    melt(id = "X_id")
})



```


Sidebar {.sidebar}
=====================================

```{r}
# Department Selction
selectInput("DpartmentSelect",
            "Department Name:",
            choices = sort(unique(cost_rev$department_name)),
            multiple = TRUE,
            selectize = TRUE,
            selected = c("Department of Finance", "DPW-Operations","DPS-Police"))

# General ledger Date Select
selectInput("DateSelect",
            "Date:",
            choices = sort(unique(cost_rev$date_2018)),
            multiple = TRUE,
            selectize = TRUE,
            selected = c("2018-01-04", "2018-01-05", "2018-01-08", "2018-01-09", "2018-01-10"))

# Account Selection
checkboxGroupInput("AccountSelect",
                   "Account Size:",
                   choices = sort(unique(cost_rev$object_account_description)),
                   selected = c("GRANTS","CDBG-CITY PLANNING","BOND PROCEEDS"))
                              
# Amount Selection
sliderInput("AmountSelect",
            "Amount:",
            min = min(cost_rev$amount, na.rm = TRUE),
            max = max(cost_rev$amount, na.rm = TRUE),
            value = c(min(cost_rev$amount), max(cost_rev$amount, na.rm = TRUE)),
            step = 1)                              
                              

```

Plot
=====================================

Row 
-------------------------------------

###

```{r}
renderValueBox({
  cr <- crInput()
  num <- round(mean(cr$amount, na.rm = T), 2)
  valueBox("Avg Cost Amount", value = num, icon = "fa-balance-scale", color = "blue")
})
```

###

```{r}
renderGauge({
  rate <- round(as.numeric(length(input$DepartmentSelect))/length(unique(cost_rev_load$department_name)) * 100, 1)
  gauge(rate, min = 0, max = 100, symbol = '%', gaugeSectors(
    success = c(70, 100), warning = c(30,69), danger = c(0,29)))
})

```
###

```{r}
renderGauge({
  rate <- round(as.numeric(length(input$AccountSelect))/length(unique(cost_rev_load$object_account_description)) * 100, 1)
  gauge(rate, min = 0, max = 100, symbol = '%', gaugeSectors(
    success = c(70, 100), warning = c(30,69), danger = c(0,29)))
})

```


Row {.tabset .tabset-fade}
-------------------------------------

### Cost Amount

```{r}
renderPlotly({
  dat <- crInput()
  ggplot(data = dat, aes(x = department_name)) + geom_bar() + 
    guides(color = FALSE)
})
```

### cost for each date in 2018

```{r}
renderPlotly({
  dat <- subset(crInput(), variable == "date_2018")
  ggplot(data = dat, aes(x = DateSelect, y = as.numeric(value), fill = DateSelect)) + geom_points()
})


```

Table
=====================================

Row 
-------------------------------------

### Table 

```{r}
DT::renderDataTable({
  subset(crInput(), select = c(X_id, department_name, date_2018, cost_center_description, amount))
})


```